<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DVC 내 용 기록</title>
    <link rel="icon" href="favicon.png">
    <!-- <link rel="stylesheet" href="dvccss.css"> -->
    <script src="recorder_data.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">

    <style>
        .entry,
        .table-header {
            display: flex;
            flex-direction: row;
        }

        .display-entries {
            height: 300px;
        }

        .entry>div {
            width: 120px;
        }

        .table-header>div {
            width: 120px;
        }

        #field-gen {
            width: 50px;
        }

        .id {
            display: none;
        }

        .delete-button {
            color: white;
            background-color: black;
            border-radius: 4px;
        }

        .nav-button {
            background-color: antiquewhite;
            margin: 10px;
            padding: 5px;
            cursor: pointer;
        }

        .page-cur {
            background-color: red;
        }
    </style>
</head>

<body>
    <!-- Need:
        1. 새 뇽뇽 등록 기능 - 선택창: 이름, 종, 성별, 성격, 세대 (using <form>) -- 구현완료
        2. Statistics Calculator:
            1. 보유한 용 총 개체수 & 종별 수(bar graph 형태로 보여주기)
            2. 총 성격 수
            3. 총 성별 수
    -->
    <h2>데이터 기록툴</h2>

    <div class="new-entry">
        <form id="my-form" onsubmit="addDragonData(event)">
            <input id="field-name" type="text" name="dragon-name" placeholder="이름" maxlength="14">
            <select id="dragon-selector" name="species">
            </select>
            <select name="gender">
                <option>수컷</option>
                <option>암컷</option>
            </select>
            <select id="trait-selector" name="trait">
            </select>
            <input id="field-gen" type="number" inputmode="numeric" name="generation" value="1" min="1">
            <input id="field-memo" type="text" name="memo" placeholder="메모" maxlength="30">
            <input type="submit" value="추가">
        </form>
    </div>

    <div>
        <button onclick="clearLocalStorage()">Clear Cache</button>
    </div>

    <div style="height:60px"></div>

    <div class="display-header">
        <div class="table-header">
            <div>이름</div>
            <div>종</div>
            <div>성별</div>
            <div>성격</div>
            <div>세대</div>
            <div>메모</div>
        </div>
    </div>
    <div class="display-entries"></div>

    <div id="display-nav" style="margin-top: 30px;"></div>

    <!-- <div style="height:40px; background-color: aqua;"></div>
    <div style="height:40px; background-color: orange;"></div> -->


    <!-- All JavaScript codes below -->
    <script>
        let dragons = [];
        let counterData, nameCount, totalDragonCount, idCount;
        const entriesPerPage = 10;
        let pageIndex = 0;

        // else 컨디션만 체크하게끔(카운터 데이터 없으면 신규생성만 하는걸로) 리펙토링 필요
        // in the middle of converting all totaldragoncount to length of dragons array
        // rename "counters" to "indices"
        if (localStorage.getItem("counters")) {
            refreshData();

            nameCount = counterData["name-count"];
            idCount = counterData["id-count"];
            totalDragonCount = dragons.length;
        }
        else {
            let counters = { "name-count": 1, "total-owned": 0, "id-count": 0 }

            const startCounters = JSON.stringify(counters);
            localStorage.setItem("counters", startCounters);

            counterData = counters;
            nameCount = counterData["name-count"];
            totalDragonCount = counterData["total-owned"];
            idCount = counterData["id-count"];
        }

        if (localStorage.getItem("mydragons")) {
            const getDragonData = localStorage.getItem("mydragons");
            dragons = JSON.parse(getDragonData);

            // call dataprint function here
            printPage(pageIndex);
        }

        // Get latest dragon data and counter data
        function refreshData() {
            const getDragonData = localStorage.getItem("mydragons");
            dragons = JSON.parse(getDragonData);

            const getCounterData = localStorage.getItem("counters");
            counterData = JSON.parse(getCounterData);
        }

        function deleteData() {
            // Get latest local storage data
            refreshData();

            // Identify this row's id
            const getId = event.target.parentNode.previousElementSibling.id;
            const dragonsUpdated = dragons.filter(x => x["id"] != getId);
            const updatedList = JSON.stringify(dragonsUpdated);
            localStorage.setItem("mydragons", updatedList);

            //subtract total dragon count
            totalDragonCount--;

            /* old code for calculating new total dragon count
            counterData["total-owned"]--;
            totalDragonCount = counterData["total-owned"];
            */

            //update dragon count
            const newCount = JSON.stringify(counterData);
            localStorage.setItem("counters", newCount);

            // Remove row element from table
            const thisRow = event.target.parentNode.parentNode;
            thisRow.remove();

            printPage(pageIndex);
        }

        function addDragonData(e) {
            e.preventDefault();

            // Get fresh dragon data
            if (localStorage.getItem("mydragons")) {
                const getDragonData = localStorage.getItem("mydragons");
                dragons = JSON.parse(getDragonData);
            }

            let entryData = Object.fromEntries(new FormData(e.target));

            // add auto-generated dragon name to entryData
            if (entryData["dragon-name"] == '') {
                const defaultName = `드래곤 #${nameCount}`;
                nameCount++;
                entryData["dragon-name"] = defaultName;
            }

            // assign id to entryData
            entryData.id = idCount;
            dragons.push(entryData);

            totalDragonCount++;
            idCount++;

            // Save newly added dragon data to localStorage and update counter data
            const newData = JSON.stringify(dragons);
            localStorage.setItem("mydragons", newData);

            counterData["name-count"] = nameCount;
            counterData["total-owned"] = totalDragonCount;
            counterData["id-count"] = idCount;
            const newCount = JSON.stringify(counterData);
            localStorage.setItem("counters", newCount);

            // document.querySelector("form").reset();
            document.querySelector("#field-name").value = "";
            document.querySelector("#field-memo").value = "";

            // This goes through the process of re-printing entire current page even when the added data appears in another page; refactor later if possible
            // But do I really need to refactor this? It's still helpful if newly added content appears on the same page as current
            printPage(pageIndex);
        }

        function printNavBar() {
            // printing number of pages
            const navArea = document.querySelector("#display-nav");
            navArea.innerHTML = "";

            // take dragons array and divide by entries per page
            // create span number with onclick event to show proper set of entries accordingly 
            const pages = Math.ceil(dragons.length / entriesPerPage);
            for (let i = 0; i < pages; i++) {
                let pageNumber = document.createElement("span");
                pageNumber.textContent = i + 1;
                pageNumber.addEventListener("click", (e) => {
                    pageIndex = pageNumber.textContent - 1;
                    printPage(pageIndex);
                });
                pageNumber.setAttribute("class", "nav-button");
                if (pageIndex === i) pageNumber.setAttribute("class", "nav-button page-cur");
                navArea.append(pageNumber);
            }
        }

        function printPage(index) {
            refreshData();

            // printing first page of dragons
            // print first 10 (entriesPerPage)
            let startIndex = index * entriesPerPage;
            const dataToPrint = dragons.slice(startIndex, startIndex + entriesPerPage);
            const tableArea = document.querySelector(".display-entries");

            tableArea.innerHTML = "";

            for (const data of dataToPrint) {
                let newRow = document.createElement("div");
                newRow.setAttribute("class", "entry");

                for (const prop in data) {
                    let entryText = document.createElement("div");

                    if (prop == "id") {
                        entryText.setAttribute("id", data["id"]);
                        entryText.setAttribute("class", "id");
                    }
                    else {
                        entryText.innerText = `${data[prop]}`;
                    }

                    newRow.appendChild(entryText);
                }

                let deleteBtn = document.createElement("div");
                deleteBtn.innerHTML = '<button class="delete-button" onclick="deleteData()">Delete</button>';
                newRow.appendChild(deleteBtn);

                tableArea.append(newRow);
            }

            printNavBar();

            // Automatically move to previous page if deleted everything on this page
            if (tableArea.innerHTML == "") {
                pageIndex--;
                printPage(pageIndex);
            }
        }

        function clearLocalStorage() {
            let key = prompt("전체 데이터를 삭제합니다. 삭제를 원하시면 단어 [삭제]를 입력해주세요.");

            if (key === "삭제" || key === "[삭제]") {
                localStorage.clear();
                dragons = [];
            }

        }


        /*
        //  Old code to delete
        function addTableData(entryData, idNum) {
            const tableArea = document.querySelector(".display-entries");
            const newRow = document.createElement("div");
            newRow.setAttribute("class", "entry");
            entryData.id = idNum;

            for (const data in entryData) {
                let entryText = document.createElement("div");

                if (data == "id") {
                    entryText.setAttribute("id", entryData[data]);
                    entryText.setAttribute("class", "id");
                }
                else {
                    entryText.innerText = `${entryData[data]}`;
                }

                newRow.appendChild(entryText);

                if (data == "dragon-name" && entryText.innerText == '') {
                    entryText.innerText = `드래곤 #${nameCount}`;
                    nameCount++;
                }
            }

            let deleteBtn = document.createElement("div");
            deleteBtn.innerHTML = '<button class="delete-button" onclick="deleteData()">Delete</button>';
            newRow.appendChild(deleteBtn);

            tableArea.append(newRow);
        }

        function printLoadedData(dragonData) {
            //create new elements and draw out the table using localstorage data
            const tableArea = document.querySelector(".display-entries");

            for (const data of dragonData) {
                let newRow = document.createElement("div");
                newRow.setAttribute("class", "entry");

                for (const prop in data) {
                    let entryText = document.createElement("div");

                    if (prop == "id") {
                        entryText.setAttribute("id", data["id"]);
                        entryText.setAttribute("class", "id");
                    }
                    else {
                        entryText.innerText = `${data[prop]}`;
                    }

                    newRow.appendChild(entryText);
                }

                let deleteBtn = document.createElement("div");
                deleteBtn.innerHTML = '<button class="delete-button" onclick="deleteData()">Delete</button>';
                newRow.appendChild(deleteBtn);

                tableArea.append(newRow);
            }
        }

        Old code in addDragonData:
        // Print out new table row
        addTableData(entryData, idCount);
        */
    </script>
</body>

</html>
