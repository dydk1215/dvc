<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DVC 내 용 기록</title>
    <!-- <link rel="icon" href="favicon.png"> -->
    <script src="recorder_data.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">

    <style>
        * {
            font-family: 'Noto Sans KR', sans-serif;
        }

        #content {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .display-table {
            display: flex;
            flex-direction: column;
            /* align-items: center; */
            width: 70vw;
        }

        .entry,
        .table-header {
            display: grid;
            grid-template-columns: 215px 180px 80px 150px 80px 450px 30px;

            margin: 5px;
            border-radius: 8px;
            padding: 5px;
            justify-content: center;
            text-align: center;
        }

        #display-nav {
            display: flex;
            flex-direction: row;
            justify-content: center;
        }

        .table-header {
            text-align: center;
        }

        .entry {
            font-size: 0.9rem;
            grid-template-rows: 30px;
            align-items: center;
            background-color: #fff5f5;
            border: 1px solid rgb(237, 150, 179);
            box-shadow: 1px 1px 2px rgb(231, 223, 223);

            animation-name: del;
            animation-duration: 0.4s;
            animation-fill-mode: forwards;
            animation-play-state: paused;
        }

        .display-entries {
            height: 500px;
        }

        #field-gen {
            width: 50px;
        }

        .id {
            display: none;
        }

        .delete-button {
            cursor: pointer;
        }

        .nav-button {
            box-shadow: 3px 3px 3px rgb(231, 223, 223);
            text-align: center;
            margin: 7px;
            padding: 5px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 5px;
            width: 20px;
        }

        .arrow-inactive {
            color: rgb(214, 214, 214);
            cursor: default;
        }

        .page-cur {
            background-color: rgb(247, 152, 204);
        }

        .entry:hover {
            background-color: rgb(255, 225, 243);
        }

        #my-form {
            display: inline-block;
        }

        @keyframes del {
            0% {
                opacity: 1;
                height: auto;
                margin: 5px;
                padding: 5px;
            }

            90% {
                opacity: 0;
                height: auto;
                margin: 5px;
                padding: 5px;
            }

            95% {
                opacity: 0;
                height: 0px;
                margin: 0px;
                padding: 0px;
            }

            100% {
                opacity: 0;
                height: 0px;
                margin: 0px;
                padding: 0px;
            }
        }
    </style>
</head>

<body>
    <h2>데이터 기록툴</h2>

    <div id="content">
        <div class="new-entry">
            <form id="my-form" onsubmit="addDragonData(event)">
                <input id="field-name" type="text" name="dragon-name" placeholder="이름" maxlength="14">
                <select id="dragon-selector" name="species">
                </select>
                <select name="gender">
                    <option>수컷</option>
                    <option>암컷</option>
                </select>
                <select id="trait-selector" name="trait">
                </select>
                <input id="field-gen" type="number" inputmode="numeric" name="generation" value="1" min="1">
                <input id="field-memo" type="text" name="memo" placeholder="메모" maxlength="25">
                <input type="submit" value="추가">
            </form>
            <button onclick="clearLocalStorage()">캐시 삭제</button>
        </div>

        <div style="height:60px"></div>

        <div class="display-table">
            <div class="display-header">
                <div class="table-header">
                    <div><strong>이름</strong></div>
                    <div><strong>종</strong></div>
                    <div><strong>성별</strong></div>
                    <div><strong>성격</strong></div>
                    <div><strong>세대</strong></div>
                    <div><strong>메모</strong></div>
                    <div></div>
                </div>
            </div>
            <div class="display-entries"></div>

            <div id="display-nav"></div>
        </div>
    </div>

    <!-- All JavaScript codes below -->
    <script>
        let dragons = [];
        let counterData, nameCount, totalDragonCount, idCount;
        const entriesPerPage = 10;
        let pageIndex = 0;

        // Get rid of duplicate methods later
        if (localStorage.getItem("counters")) {
            refreshData();

            nameCount = counterData["name-count"];
            idCount = counterData["id-count"];
        }
        else {
            let counters = { "name-count": 1, "id-count": 0 }

            const startCounters = JSON.stringify(counters);
            localStorage.setItem("counters", startCounters);

            counterData = counters;
            nameCount = counterData["name-count"];
            idCount = counterData["id-count"];
        }

        if (localStorage.getItem("mydragons")) {
            const getDragonData = localStorage.getItem("mydragons");
            dragons = JSON.parse(getDragonData);

            // Call dataprint function here
            printPage(pageIndex);
        }

        // Get latest dragon data and counter data
        function refreshData() {
            const getDragonData = localStorage.getItem("mydragons");
            dragons = JSON.parse(getDragonData);

            const getCounterData = localStorage.getItem("counters");
            counterData = JSON.parse(getCounterData);
        }

        function deleteData() {
            // Get latest local storage data
            refreshData();

            // Identify this row's id
            const getId = event.target.parentNode.previousElementSibling.id;
            const dragonsUpdated = dragons.filter(x => x["id"] != getId);
            const updatedList = JSON.stringify(dragonsUpdated);
            localStorage.setItem("mydragons", updatedList);

            //update dragon count
            const newCount = JSON.stringify(counterData);
            localStorage.setItem("counters", newCount);

            // Remove row element from table
            const thisRow = event.target.parentNode.parentNode;
            thisRow.style.animationPlayState = "running";
            thisRow.addEventListener("animationend", () => {
                thisRow.remove();
                printPage(pageIndex);
            });
        }

        function addDragonData(e) {
            e.preventDefault();

            // Get fresh dragon data
            if (localStorage.getItem("mydragons")) {
                const getDragonData = localStorage.getItem("mydragons");
                dragons = JSON.parse(getDragonData);
            }

            let entryData = Object.fromEntries(new FormData(e.target));

            // add auto-generated dragon name to entryData
            if (entryData["dragon-name"] == '') {
                const defaultName = `드래곤 #${nameCount}`;
                nameCount++;
                entryData["dragon-name"] = defaultName;
            }

            // assign id to entryData
            entryData.id = idCount;
            dragons.push(entryData);

            idCount++;

            // Save newly added dragon data to localStorage and update counter data
            const newData = JSON.stringify(dragons);
            localStorage.setItem("mydragons", newData);

            counterData["name-count"] = nameCount;
            counterData["id-count"] = idCount;
            const newCount = JSON.stringify(counterData);
            localStorage.setItem("counters", newCount);

            // document.querySelector("form").reset();
            document.querySelector("#field-name").value = "";
            document.querySelector("#field-memo").value = "";

            // This goes through the process of re-printing entire current page even when the added data appears in another page; refactor later if possible
            // But do I really need to refactor this? It's still helpful if newly added content appears on the same page as current
            printPage(pageIndex);
        }

        function printNavBar() {
            // Clear out pagination
            const navArea = document.querySelector("#display-nav");
            navArea.innerHTML = "";

            // Calculate number of pages
            const pages = Math.ceil(dragons.length / entriesPerPage);
            const startPage = Math.floor(pageIndex / 5) * 5;

            // Print left arrow
            let leftArrow = document.createElement("div");
            leftArrow.innerHTML = "&lt;";
            leftArrow.setAttribute("class", "nav-button");
            leftArrow.removeEventListener;
            navArea.append(leftArrow);

            for (let i = startPage; i < startPage + 5; i++) {
                if (i === pages) break;
                let pageNumber = document.createElement("div");
                pageNumber.textContent = i + 1;
                pageNumber.addEventListener("click", (e) => {
                    pageIndex = pageNumber.textContent - 1;
                    printPage(pageIndex);
                });
                pageNumber.setAttribute("class", "nav-button");
                if (pageIndex === i) pageNumber.setAttribute("class", "nav-button page-cur");
                navArea.append(pageNumber);
            }

            // Print right arrow
            let rightArrow = document.createElement("div");
            rightArrow.innerHTML = "&gt;";
            rightArrow.setAttribute("class", "nav-button");
            rightArrow.removeEventListener;
            navArea.append(rightArrow);

            // Activate/deactivate left arrow
            // get first child element of page numbers, if it's 1 then inactive, if > 1 then change pageIndex accordingly
            let firstPage = navArea.firstChild.nextSibling.innerHTML;
            let lastPage = navArea.lastChild.previousSibling.innerHTML;

            if (firstPage <= 1) {
                leftArrow.setAttribute("class", "nav-button arrow-inactive");
            }
            else if (firstPage >= 6) {
                leftArrow.addEventListener("click", (e) => {
                    pageIndex = parseInt(firstPage) - 6;
                    printPage(pageIndex);
                });
            }

            // the conditional that didn't work: lastPage % 5 !== 0
            if (pages <= 5 || lastPage % 5 !== 0 || pages <= parseInt(lastPage)) {
                rightArrow.setAttribute("class", "nav-button arrow-inactive");
            }
            else {
                rightArrow.addEventListener("click", (e) => {
                    pageIndex = parseInt(lastPage);
                    printPage(pageIndex);
                });
            }
        }

        function printPage(index) {
            refreshData();

            if (dragons.length <= 0) {
                printNavBar();
                return;
            }

            let startIndex = index * entriesPerPage;
            const dataToPrint = dragons.slice(startIndex, startIndex + entriesPerPage);
            const tableArea = document.querySelector(".display-entries");

            tableArea.innerHTML = "";

            for (const data of dataToPrint) {
                let newRow = document.createElement("div");
                newRow.setAttribute("class", "entry");

                for (const prop in data) {
                    let entryText = document.createElement("div");

                    if (prop == "id") {
                        entryText.setAttribute("id", data["id"]);
                        entryText.setAttribute("class", "id");
                    }
                    else {
                        entryText.innerText = `${data[prop]}`;
                    }

                    newRow.appendChild(entryText);
                }

                let deleteBtn = document.createElement("div");
                deleteBtn.innerHTML = '<img src="trash.png" width="15" alt="Delete button" class="delete-button" onclick="deleteData()">';
                newRow.appendChild(deleteBtn);

                tableArea.append(newRow);
            }

            printNavBar();

            // Automatically move to previous page if deleted everything on this page
            if (tableArea.innerHTML == "") {
                pageIndex--;
                printPage(pageIndex);
            }
        }

        function clearLocalStorage() {
            let key = prompt("데이터를 일괄 삭제합니다. 삭제된 데이터는 복구할 수 없습니다.\n삭제를 원하시면 단어 [삭제]를 입력해주세요.");

            if (key === "삭제" || key === "[삭제]") {
                localStorage.clear();
                location.reload();
            }
        }
    </script>
</body>

</html>
